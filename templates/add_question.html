{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% block content %}
<div class="container mt-4">
    <h2>Добавить вопрос к тесту: {{ test.title }}</h2>
    <form method="post">
        {% csrf_token %}
        <div class="form-group">
            {{ question_form.text|as_crispy_field }}  <!-- Текст вопроса -->
        </div>
        <div class="form-group">
            {{ question_form.question_type|as_crispy_field }}  <!-- Тип вопроса -->
        </div>

        <h4>Варианты ответов</h4>
        {{ formset.management_form }}
        <div id="answer-forms">
            {% for form in formset %}
            <div class="form-row answer-row">
                <div class="col">
                    {{ form.text|as_crispy_field }}  <!-- Вопрос или часть вопроса -->
                </div>

                <!-- Поле is_correct будет скрыто для типа вопроса "match" и "sequence" -->
                <div class="col">
                    {{ form.is_correct|as_crispy_field }}
                </div>

                <!-- Поле для соответствия (match_pair) отображается только для вопросов типа "match" -->
                <div class="col match-field" style="display: none;">
                    {{ form.match_pair|as_crispy_field }}  <!-- Соответствие -->
                </div>
            </div>
            <hr>
            {% endfor %}
        </div>

        <button type="submit" class="btn btn-primary mt-3">Сохранить вопрос и ответы</button>
    </form>
</div>

{% block extra_scripts %}
<script>
    const questionTypeField = document.getElementById('id_question_type');
    const answerRows = document.querySelectorAll('.answer-row');

    // Функция для отображения полей в зависимости от типа вопроса
    function toggleFields() {
        const isMatchType = questionTypeField.value === 'match';
        const isSequenceType = questionTypeField.value === 'sequence';

        answerRows.forEach((row, index) => {
            const matchField = row.querySelector('.match-field');
            const isCorrectField = row.querySelector('[name$="is_correct"]');

            // Показываем/скрываем поле match_pair для типа match
            if (matchField) {
                matchField.style.display = isMatchType ? '' : 'none';
            }

            // Скрываем поле is_correct для типа sequence или match
            if (isCorrectField) {
                isCorrectField.parentElement.style.display = (isSequenceType || isMatchType) ? 'none' : '';
            }

            // Если выбран тип "sequence", показываем только 4 ответа
            if (isSequenceType) {
                if (index < 4) {
                    row.style.display = '';  // Показываем первые 4 строки
                } else {
                    row.style.display = 'none';  // Скрываем остальные
                }
            } else if (isMatchType) {
                row.style.display = '';  // Показываем все строки
            } else {
                row.style.display = '';  // Показываем все строки для других типов вопросов
            }
        });
    }

    // Обработчик изменения типа вопроса
    questionTypeField.addEventListener('change', toggleFields);

    // Первоначальный вызов функции при загрузке страницы
    toggleFields();
</script>
{% endblock %}
{% endblock %}
