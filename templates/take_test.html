{% extends 'base.html' %}
{% load timer_filters %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 col-md-12">
            <h2>Прохождение теста: {{ test.title }}</h2>
            <form id="test-form" method="post" onsubmit="document.getElementById('time-left-input').value = timeLeft;">
                {% csrf_token %}
                <input type="hidden" id="time-left-input" name="time_left" value="{{ time_left }}">
                <div class="question mt-4 p-3 border rounded">
                    <h4>{{ current_question_number }}. {{ current_question.text }}</h4>

                    <!-- Варианты ответов для каждого типа вопроса -->
                    {% if current_question.question_type == 'single' %}
                        {% for answer in current_question.answers_shuffled %}
                            <div class="form-check">
                                <input type="radio" name="question_{{ current_question.id }}" value="{{ answer.id }}" class="form-check-input" required>
                                <label class="form-check-label">{{ answer.text }}</label>
                            </div>
                        {% endfor %}
                    {% elif current_question.question_type == 'true_false' %}
                        <div class="form-check">
                            <input type="radio" name="question_{{ current_question.id }}" value="true" class="form-check-input" required>
                            <label class="form-check-label">Верно</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" name="question_{{ current_question.id }}" value="false" class="form-check-input" required>
                            <label class="form-check-label">Неверно</label>
                        </div>
                    {% elif current_question.question_type == 'multiple' %}
                        {% for answer in current_question.answers_shuffled %}
                            <div class="form-check">
                                <input type="checkbox" name="question_{{ current_question.id }}_answers" value="{{ answer.id }}" class="form-check-input">
                                <label class="form-check-label">{{ answer.text }}</label>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="mt-3">
                    {% if not is_last_question %}
                        <button type="submit" id="submit-btn" class="btn btn-primary">Следующий вопрос</button>
                    {% else %}
                        <button type="submit" id="submit-btn" class="btn btn-success">Завершить тест</button>
                    {% endif %}
                </div>
            </form>
        </div>

        <!-- Панель таймера и статистики -->
        <div class="col-lg-4 col-md-12 mt-4 mt-lg-0">
            <div class="sticky-top">
                <div class="alert alert-info">
                    <h5>Информация о тесте</h5>
                    <p><strong>Время до завершения:</strong> <span id="timer">{{ time_left|minutes }}:{{ time_left|seconds|stringformat:"02d" }}</span></p>
                    <p><strong>Всего вопросов:</strong> {{ total_questions }}</p>
                    <p><strong>Отвечено:</strong> {{ answered_questions }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const timerElement = document.getElementById('timer');
    let timeLeft = {{ time_left }};

    function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerElement.textContent = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
        if (timeLeft > 0) {
            timeLeft--;
        } else {
            document.getElementById('test-form').submit();
        }
    }
    setInterval(updateTimer, 1000);
</script>
{% endblock %}
